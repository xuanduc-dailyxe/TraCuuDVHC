<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Tra cứu Sáp nhập</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta3/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <style>
    #editor {
      height: 400px;
      border: 1px solid #ccc;
      margin-top: 20px;
      font-size: 14px;
    }

    .CodeMirror {
      height: 100%;
      font-size: 14px;
    }

    #resultValue {
      font-size: 120%;
      font-weight: bold;
      color: rgb(17, 105, 0);
    }

    @media (max-width: 576px) {

      h2,
      h3 {
        font-size: 1.1rem;
        margin-bottom: 0.7rem;
      }

      .form-group label,
      .input-group-append .btn {
        font-size: 0.95rem;
      }

      #editor {
        height: 200px;
        font-size: 12px;
      }

      .CodeMirror {
        font-size: 12px;
      }

      #resultValue {
        font-size: 1rem;
      }

      .table {
        font-size: 12px;
      }

      .input-group-append {
        width: 100%;
        margin-top: 5px;
      }

      .input-group-append .btn {
        width: 100%;
      }

      #resultValue {
        margin-bottom: 5px;
      }
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h2 class="mb-4">Tra cứu Sáp nhập Địa phương</h2>

    <div class="form-group">
      <label for="searchInput">Tìm kiếm:</label>
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="Nhập ví dụ: Phường An Phú, TP.Thủ Đức, TP.HCM">
        <div class="input-group-append">
          <button class="btn btn-secondary" type="button" id="clearSearchBtn" title="Xóa nhanh" style="display:none;background-color: transparent;color: #333;border: none;position: absolute;top: -2px;right: 60px;z-index: 1000;box-shadow: none; font-size: 120%;">&times;</button>
          <button class="btn btn-primary" type="button" id="searchBtn">Tìm</button>
        </div>

      </div>
      <small>Ví dụ: Phường An Phú, TP.Thủ Đức, TP.HCM</small>
    </div>
    <div class="form-group">
      <label for="inputId">Chọn Tỉnh/Thành:</label>
      <select id="inputId" class="selectpicker form-control" data-live-search="true" title="Chọn tỉnh...">
      </select>
    </div>

    <div class="form-group">
      <label for="resultValue">Địa chỉ mới:</label>
      <div class="input-group">
        <input type="text" id="resultValue" class="form-control">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="copyBtn">Copy</button>
        </div>
      </div>
    </div>
    <p id="warning"></p>
    <p id="detail"></p>
    <p id="detail2"></p>
    <p><a class="btn-link" href="https://thuvienphapluat.vn/phap-luat/ho-tro-phap-luat/toan-bo-34-nghi-quyet-sap-xep-don-vi-hanh-chinh-cap-xa-ca-nuoc-nam-2025-tai-toan-bo-34-nghi-quyet-s-978819-221767.html" target="_blank">Xem danh sách nghị quyết</a></p>
    <h3 class="mt-4">Danh sách:</h3>
    <div id="resultTable"></div>
    <div id="editor" class="mt-4"></div>
    <div class="text-center p-2">
      <p>Data lấy từ: <a href="https://sapnhap.bando.com.vn/" target="_blank">sapnhap.bando.com.vn</a></p>
    </div>
  </div>

  <!-- JS libraries -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta3/js/bootstrap-select.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>

  <script>
    const editor = CodeMirror(document.getElementById('editor'), {
      mode: 'application/json',
      lineNumbers: true,
      theme: 'default',
      readOnly: true,
      height: '1400px'
    });

    // Load danh sách tỉnh/thành
    function loadTinhThanh() {
      // Đọc file tinhthanh.json nội bộ
      fetch('tinhthanh.json')
        .then(res => res.json())
        .then(data => {
          const $select = $('#inputId');
          $select.empty();
          data.forEach(item => {
            $select.append(
              $('<option>', {
                value: item.mahc,
                text: item.tentinh
              })
            );
          });
          $select.selectpicker('refresh');
        })
        .catch(err => {
          alert("Không thể tải danh sách tỉnh/thành từ file tinhthanh.json");
        });
    }


    function traCuu(callback) {
      const inputId = $('#inputId').val();
      if (!inputId) {
        alert("Vui lòng chọn tỉnh/thành.");
        if (callback) callback(null, null);
        return;
      }
      console.log('Tra cứu ID:', inputId);
      // Kiểm tra localStorage trước
      let cacheKey = 'ptracuu_' + inputId;
      let cached = localStorage.getItem(cacheKey);
      if (cached) {
        let cacheObj = JSON.parse(cached);
        // cacheObj: {filtered, raw}
        processData(cacheObj.raw, false); // hiển thị lại từ raw, không lưu lại cache nữa
        if (callback) callback(cacheObj.filtered, cacheObj.raw);
        return;
      }
      // Lấy dữ liệu từ data.json nội bộ
      fetch('data.json')
        .then(res => res.json())
        .then(allData => {
          // Tìm entry theo id (so sánh chuỗi hoặc số)
          let found = allData.find(item => String(item.id) === String(inputId));
          if (!found) {
            editor.setValue('Không tìm thấy dữ liệu cho id: ' + inputId);
            $('#resultTable').html('<div class="text-danger">Không tìm thấy dữ liệu cho id này</div>');
            if (callback) callback(null, null);
            return;
          }
          let data = found.data || [];
          processData(data, true);
        })
        .catch(err => {
          editor.setValue(`Lỗi khi đọc file data.json:\n${err}`);
          $('#resultTable').html('<div class="text-danger">Lỗi khi đọc file data.json</div>');
          if (callback) callback(null, null);
        });

      function processData(data, saveToCache) {
        // Chỉ lấy các thuộc tính cần thiết
        function pickFields(obj) {
          return {
            id: obj.id,
            loai: obj.loai,
            tenhc: obj.tenhc,
            tentinh: obj.tentinh,
            truocsapnhap: obj.truocsapnhap
          };
        }
        let filtered;
        if (Array.isArray(data)) {
          filtered = data.map(pickFields);
        } else if (typeof data === 'object' && data !== null) {
          filtered = pickFields(data);
        } else {
          filtered = data;
        }
        editor.setValue(JSON.stringify(filtered, null, 2));

        // Hiển thị bảng HTML
        function renderTable(rows) {
          if (!Array.isArray(rows)) rows = [rows];
          if (!rows.length) return '<div>Không có dữ liệu</div>';
          let html = '<table class="table table-bordered table-striped">';
          html += '<thead><tr>';
          html += '<th>STT</th><th>ID</th><th>Tên</th><th>Tỉnh/Thành</th><th>Trước Sáp Nhập</th>';
          html += '</tr></thead><tbody>';
          rows.forEach((row, idx) => {
            html += '<tr>' +
              `<td>${idx + 1}</td>` +
              `<td>${row.id ?? ''}</td>` +
              `<td>${row.tenhc ?? ''}</td>` +
              `<td>${row.tentinh ?? ''}</td>` +
              `<td>${row.truocsapnhap ?? ''}</td>` +
              '</tr>';
          });
          html += '</tbody></table>';
          return html;
        }
        $('#resultTable').html(renderTable(filtered));
        if (saveToCache) {
          // Lưu cả filtered và raw để callback dùng lại
          localStorage.setItem(cacheKey, JSON.stringify({ filtered, raw: data }));
        }
        if (callback) callback(filtered, data);
      }
    }


    $('#readBtn').on('click', function () { traCuu(); });
    $('#inputId').on('changed.bs.select', function () { traCuu(); });

    // Xử lý tìm kiếm theo input
    $('#searchBtn').on('click', handleSearch);
    $('#searchInput').on('keypress', function (e) {
      if (e.which === 13) handleSearch();
    });
    // Khi dán dữ liệu vào input thì tự động tìm kiếm
    $('#searchInput').on('paste', function (e) {
      setTimeout(function () {
        $('#searchBtn').trigger('click');
      }, 0);
    });

    function handleSearch() {
      let val = $('#searchInput').val().trim();
      if (!val) return;
      // Chuẩn hóa tên TP.HCM
      val = val.replace(/TP\. ?HCM|TP\. ?Hồ Chí Minh|Thành Phố Hồ Chí Minh|TP. HCM/gi, 'Hồ Chí Minh');
      val = val.replace(/Phường/g, '').replace(/TP./g, '').replace("P.", "").replace(/Xã/g, '').replace(/Thủ đô /g, '')
      val = val.replace("Tỉnh ", "");
      // Tách tỉnh/thành cuối cùng
      const parts = val.split(',').map(s => s.trim());
      if (parts.length < 2) {
        alert('Vui lòng nhập đúng định dạng: "Phường An Phú, TP.Thủ Đức, TP.HCM"');
        return;
      }


      let tentinh = parts[parts.length - 1];
      // Xóa các ký tự đặc biệt khỏi tentinh
      tentinh = tentinh.replace(/[^\p{L}\p{N}\s]/gu, '').trim();

      tentinh = tentinh.replace(/TP\.?\s*/gi, "").trim();
      tentinh = tentinh.replace("Thừa Thiên ", "").trim();
      // Danh sách ánh xạ tỉnh/thành
      const provinceMap = [
        { "name": "Hà Nội", "item": ["Hà Nội"] },
        { "name": "Huế", "item": ["Huế"] },
        { "name": "Lai Châu", "item": ["Lai Châu"] },
        { "name": "Điện Biên", "item": ["Điện Biên"] },
        { "name": "Sơn La", "item": ["Sơn La"] },
        { "name": "Lạng Sơn", "item": ["Lạng Sơn"] },
        { "name": "Quảng Ninh", "item": ["Quảng Ninh"] },
        { "name": "Thanh Hóa", "item": ["Thanh Hóa"] },
        { "name": "Nghệ An", "item": ["Nghệ An"] },
        { "name": "Hà Tĩnh", "item": ["Hà Tĩnh"] },
        { "name": "Cao Bằng", "item": ["Cao Bằng"] },
        { "name": "Tuyên Quang", "item": ["Hà Giang", "Tuyên Quang"] },
        { "name": "Lào Cai", "item": ["Lào Cai", "Yên Bái"] },
        { "name": "Thái Nguyên", "item": ["Bắc Kạn", "Thái Nguyên"] },
        { "name": "Phú Thọ", "item": ["Phú Thọ", "Vĩnh Phúc", "Hoà Bình"] },
        { "name": "Bắc Ninh", "item": ["Bắc Ninh", "Bắc Giang"] },
        { "name": "Hưng Yên", "item": ["Hưng Yên", "Thái Bình"] },
        { "name": "Hải Phòng", "item": ["Hải Phòng", "Hải Dương"] },
        { "name": "Ninh Bình", "item": ["Ninh Bình", "Hà Nam", "Nam Định"] },
        { "name": "Quảng Trị", "item": ["Quảng Trị", "Quảng Bình"] },
        { "name": "Đà Nẵng", "item": ["Đà Nẵng", "Quảng Nam"] },
        { "name": "Quảng Ngãi", "item": ["Quảng Ngãi", "Kon Tum"] },
        { "name": "Gia Lai", "item": ["Gia Lai", "Bình Định"] },
        { "name": "Khánh Hòa", "item": ["Khánh Hòa", "Ninh Thuận"] },
        { "name": "Lâm Đồng", "item": ["Lâm Đồng", "Đắk Nông", "Bình Thuận"] },
        { "name": "Đắk Lắk", "item": ["Đắk Lắk", "Phú Yên"] },
        { "name": "Thành phố Hồ Chí Minh", "item": ["Hồ Chí Minh", "Bình Dương", "Bà Rịa–Vũng Tàu"] },
        { "name": "Đồng Nai", "item": ["Đồng Nai", "Bình Phước"] },
        { "name": "Tây Ninh", "item": ["Tây Ninh", "Long An"] },
        { "name": "Cần Thơ", "item": ["Cần Thơ", "Sóc Trăng", "Hậu Giang"] },
        { "name": "Vĩnh Long", "item": ["Vĩnh Long", "Bến Tre", "Trà Vinh"] },
        { "name": "Đồng Tháp", "item": ["Đồng Tháp", "Tiền Giang"] },
        { "name": "Cà Mau", "item": ["Cà Mau", "Bạc Liêu"] },
        { "name": "An Giang", "item": ["An Giang", "Kiên Giang"] }
      ];

      // Hàm loại bỏ dấu tiếng Việt
      function removeVietnameseTones(str) {
        return str.normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
      }
      // Tìm name tương ứng với tentinh (so sánh không dấu)
      let provinceName = null;
      let provinceItems = [];
      let tentinhNoSign = removeVietnameseTones(tentinh.toLowerCase());
      for (let p of provinceMap) {
        if (p.item.some(i => removeVietnameseTones(i.toLowerCase()) === tentinhNoSign)) {
          provinceName = p.name;
          provinceItems = p.item;
          break;
        }
      }
      if (!provinceName) {
        alert('Không tìm thấy tỉnh/thành1: ' + tentinh);
        return;
      }
      // Hiển thị tên name và danh sách item lên tiêu đề danh sách
      if (provinceName && provinceItems.length > 1) {
        $("#detail").html(`<strong>Sát nhập tỉnh:</strong> ${provinceItems.join(', ')} => <strong>${provinceName}</strong>`);
      }
      // Chọn selectpicker theo name (so sánh chứa chuỗi, không so sánh chính xác)
      let found = false;
      $('#inputId option').each(function () {
        if ($(this).text().trim().toLowerCase().includes(provinceName.toLowerCase())) {
          $('#inputId').selectpicker('val', $(this).val());
          found = true;
          return false;
        }
      });
      if (!found) {
        alert('Không tìm thấy tỉnh/thành2: ' + provinceName);
        return;
      }
      // Gọi traCuu và xử lý kết quả
      traCuu(function (filtered, rawData) {
        if (!filtered) return;
        // Lấy phần tử đầu tiên trong chuỗi
        const tenSearch = parts[0];
        console.log('Searching for:', tenSearch);
        let arr = Array.isArray(filtered) ? filtered : [filtered];
        // Tìm tất cả các item khớp với tenSearch (dùng includes, không dấu)
        let tenSearchNoSign = removeVietnameseTones(tenSearch.toLowerCase());
        let matches = arr.filter(item => {
          if (!item.truocsapnhap) return false;
          if (Array.isArray(item.truocsapnhap)) {
            return item.truocsapnhap.some(x => x.tenhc && removeVietnameseTones(x.tenhc.toLowerCase()).includes(tenSearchNoSign));
          } else if (typeof item.truocsapnhap === 'string') {
            return removeVietnameseTones(item.truocsapnhap.toLowerCase()).includes(tenSearchNoSign);
          } else if (typeof item.truocsapnhap === 'object' && item.truocsapnhap.tenhc) {
            return removeVietnameseTones(item.truocsapnhap.tenhc.toLowerCase()).includes(tenSearchNoSign);
          }
          return false;
        });

        let match = null;
        if (matches.length === 1) {
          match = matches[0];
        } else if (matches.length > 1 && parts.length === 3) {
          // Ưu tiên item có truocsapnhap khớp với parts[1] - Quận/Huyện
          let mid = removeVietnameseTones(parts[1].toLowerCase().trim());
          match = matches.find(item => {
            if (!item.truocsapnhap) return false;
            if (typeof item.truocsapnhap === 'string') {
              return removeVietnameseTones(item.truocsapnhap.toLowerCase()).includes(mid);
            }
            return false;
          });
          console.log("match:", match)
          if (!match) {
            match = matches[0];
            $("#warning").html(`<strong style="color:red">Kết quả tương đối!!! <br>Có thể Phường/xã trước sát nhập bị trùng hoặc 1 phường/xã sau sát nhập chia ra nhiều phường/xã khác. <br>Hãy kiểm tra lại trong danh sách bên dưới.</strong>`)
          }
        } else if (matches.length > 0) {
          match = matches[0];
          $("#warning").html(`<strong style="color:red">Kết quả tương đối!!! <br>Có thể Phường/xã trước sát nhập bị trùng hoặc 1 phường/xã sau sát nhập chia ra nhiều phường/xã khác. <br>Hãy kiểm tra lại trong danh sách bên dưới.</strong>`)
        }
        // Hàm tạo chuỗi kết quả địa chỉ mới
        function getResultStr(item) {
          if (!item) return '';
          let tenhc = '';
          if (Array.isArray(item.truocsapnhap)) {
            let foundObj = item.truocsapnhap.find(x => x.tenhc && removeVietnameseTones(x.tenhc.toLowerCase()).includes(tenSearchNoSign));
            tenhc = foundObj ? foundObj.tenhc : '';
          } else if (typeof item.truocsapnhap === 'object' && item.truocsapnhap.tenhc) {
            tenhc = item.truocsapnhap.tenhc;
          } else if (typeof item.truocsapnhap === 'string') {
            let loaiStr = item.loai ? item.loai.charAt(0).toUpperCase() + item.loai.slice(1) : '';
            tenhc = loaiStr + " " + item.tenhc;
          }
          let tentinh = item.tentinh ? item.tentinh.replace(/thành phố/gi, 'TP.').replace(/Hồ Chí Minh/gi, 'HCM').replace(/tỉnh /gi, '').replace(/Thủ đô /gi, '') : '';
          return (tenhc ? tenhc + ', ' : '') + tentinh;
        }

        let resultStr = '';
        console.log('Match found:', match);
        if (match) {
          resultStr = getResultStr(match);
          // Nếu truocsapnhap là string, hiển thị detail2
          if (typeof match.truocsapnhap === 'string') {
            let loaiStr = match.loai ? match.loai.charAt(0).toUpperCase() + match.loai.slice(1) : '';
            let tenhc = match.tenhc || '';
            // Highlight các từ khớp với match.tenhc trong match.truocsapnhap (không phân biệt hoa thường, có dấu/không dấu)
            function highlightMatch(text, keyword) {
              if (!keyword) return text;
              // Loại bỏ dấu tiếng Việt cho so sánh
              function removeVietnameseTones(str) {
                return str.normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
              }
              let textNoSign = removeVietnameseTones(text.toLowerCase());
              let keywordNoSign = removeVietnameseTones(keyword.toLowerCase());
              // Tìm vị trí keyword trong text (không dấu)
              let idx = textNoSign.indexOf(keywordNoSign);
              if (idx === -1) return text;
              // Lấy đoạn gốc tương ứng
              let before = text.slice(0, idx);
              let matchPart = text.slice(idx, idx + keyword.length);
              let after = text.slice(idx + keyword.length);
              return before + '<span style="background:yellow">' + matchPart + '</span>' + after;
            }
            let truocHtml = highlightMatch(match.truocsapnhap, tenhc);
            let tenhcHtml = loaiStr + " " + tenhc;
            $("#detail2").html(`<strong>Sát nhập từ:</strong> ${truocHtml} => <strong>${tenhcHtml}</strong>`);
            setTimeout(function () {
              $("#resultTable tr").removeClass("table-success");
              $("#resultTable tr").each(function () {
                let idCell = $(this).find("td").eq(1).text().trim();
                if (idCell && match.id && idCell === String(match.id)) {
                  $(this).addClass("table-success");
                }
              });
            }, 100);
          }
        } else if (parts.length == 2) {
          // Lấy parts[0] đã loại bỏ "Phường", "phường", "P.", "p."
          let searchName = parts[0].replace(/Phường|phường|P\.|p\./g, '').trim();
          // So sánh không dấu với tenhc trong arr
          let searchNoSign = removeVietnameseTones(searchName.toLowerCase());
          let foundObj = arr.find(item => {
            if (!item.tenhc) return false;
            return removeVietnameseTones(item.tenhc.toLowerCase()) === searchNoSign;
          });
          if (foundObj) {
            resultStr = getResultStr(foundObj);
            setTimeout(function () {
              $("#resultTable tr").removeClass("table-success");
              $("#resultTable tr").each(function () {
                let idCell = $(this).find("td").eq(1).text().trim();
                if (idCell && foundObj.id && idCell === String(foundObj.id)) {
                  $(this).addClass("table-success");
                }
              });
            }, 100);
          } else {
            resultStr = '';
          }
        } else {
          resultStr = '';
        }
        $('#resultValue').val(resultStr);
        if (resultStr.length > 0) {
          $('#copyBtn').trigger('click');
        }
      });
    }

    // Copy to clipboard
    $('#copyBtn').on('click', function () {
      const val = $('#resultValue').val();
      if (!val) return;
      navigator.clipboard.writeText(val).then(function () {
        $('#copyBtn').text('Đã copy!');
        setTimeout(() => $('#copyBtn').text('Copy'), 5000);
      });
    });

    // Hàm tải toàn bộ dữ liệu các tỉnh/thành và lưu vào localStorage
    async function loadDataAll() {
      let res = await fetch('tinhthanh.json');
      let tinhthanh = await res.json();
      let allData = [];
      for (let i = 0; i < tinhthanh.length; i++) {
        let item = tinhthanh[i];
        try {
          let response = await fetch("https://sapnhap.bando.com.vn/ptracuu", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${encodeURIComponent(item.id)}`
          });
          let data = await response.json();
          // Chuẩn hóa dữ liệu lấy về, chỉ lấy các trường cần thiết
          let extract = (obj) => ({
            id: obj.id,
            loai: obj.loai,
            tenhc: obj.tenhc,
            tentinh: obj.tentinh,
            truocsapnhap: obj.truocsapnhap
          });
          let result = null;
          if (Array.isArray(data)) {
            result = data.map(extract);
          } else if (typeof data === 'object' && data !== null) {
            result = extract(data);
          } else {
            result = data;
          }
          allData.push({
            mahc: item.mahc,
            tentinh: item.tentinh,
            id: item.id,
            data: result
          });
        } catch (e) {
          allData.push({ mahc: item.mahc, tentinh: item.tentinh, id: item.id, data: null, error: true });
        }
        console.log("Đã tải ", item.tentinh);
        await new Promise(r => setTimeout(r, 1000));
      }
      localStorage.setItem('listAll', JSON.stringify(allData));
      alert('Đã tải xong toàn bộ dữ liệu các tỉnh/thành!');
    }

    // Gọi khi trang tải xong
    $(document).ready(function () {
      loadTinhThanh();
      //loadDataAll();

      $("#searchInput").focus();

      // Hiện/ẩn nút xóa nhanh cho searchInput
      $('#searchInput').on('input', function () {
        if ($(this).val().length > 0) {
          $('#clearSearchBtn').show();
        } else {
          $('#clearSearchBtn').hide();
        }
      });
      $('#clearSearchBtn').on('click', function () {
        $('#searchInput').val('').focus();
        $(this).hide();
      });
    });
  </script>
</body>

</html>